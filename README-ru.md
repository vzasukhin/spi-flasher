# SPI Flasher

[English](README.md) **[Русский]**

Утилита для Linux предназначена для прошивки, очистки и чтения памятей SPI NOR.
Работает через микросхему-переходник USB->SPI CH341A. Протокол работы с CH341A был
подсмотрен в https://github.com/setarcos/ch341prog

Для сборки требуется пакет libusb.

Список поддерживаемых микросхем:

- M25Pxx
- S25FLxxxS, S25FSxxxS, S25FSxxxP, S79FLxxxS, S79FSxxxS
- W25Q32BV, W25Q64FV, W25Q128JV-IN/IQ/JQ/JM/FW
- MT25Qxxx

Можно использовать другие микросхемы, если явно указать их параметры (см. `--flash-size`,
`--flash-eraseblock`, `--flash-page`).

Использование:

```
spi-flasher [опции] <команда> ...
```

Список команд:

- `read` - прочитать данные из SPI-памяти;
- `flash` - записать данные на SPI-память;
- `erase` - очистить участок памяти;
- `custom` - передать по SPI произвольные данные и вывести в консоль ответ.

Список дополнительных опций:

- `-o`, `--offset` - указать смещение (начальный адрес) для чтения/записи/очистки;
- `-s`, `--size` - указать количество данных для чтения/записи/очистки;
- `--hide-progress` - не выводить прогресс-бар (может пригодиться для автоматических запусков,
  что бы не засорять лог);
- `--custom-duplex` - для команды `custom` выводить ответ начиная с первого байта. Если этот
  аргумент не указан, то ответ начнёт считаться после передачи запроса;
- `--flash-size` - переопределить размер SPI-флешки;
- `--flash-eraseblock` - переопределить размер erase-блока (сектора);
- `--flash-page` - переопредлить размер страницы.

Размер может быть указан либо как число (будет считаться в байтах), либо с буквенным окончанием,
как использует утилита `dd`. Числа могут быть указаны в десятично системе счисления,
шестнадцатиричной (с приставкой "0x") или в восьмиричной (число, начинающееся на "0"):

- `K` или `KiB` = 1024
- `M` или `MiB` = 1024KiB = 1048576
- `G` или `GiB` = 1024MiB = 1073741824
- `kB` = 1000
- `MB` = 1000kB = 1000000
- `GB` = 1000MB = 1000000000
- 0x100 = 256
- 0100 = 64

Примеры запуска:

```bash
# прочитать 128 кибибайт (131072 байт) с флешки
spi-flasher -s 128K read file.dat

# прочитать 1 мибибайт (1048576 байт), начиная с адреса 3 мебибайта (3145728 байт)
# при этом первые 3 мебибайта останутся непрочитанными
spi-flasher -o 3MiB -s 1MiB read file.dat

# прочитать 1 мегабайт (1000000 байт) и при этом считать,
# что размер флешки равен 2 мебибайтам (2097152 байтам)
# может быть полезно, если флешка не определяется, либо определяется неправильно
spi-flasher --flash-size 2M -s 1MB read file.dat

# прошить файл во флешку (вручную запускать очистку не требуется)
spi-flasher flash file.dat

# прошить данные с использованием конвеера (записав в stdin)
echo "Some data from command line" | spi-flasher flash -
```

## Команда read

Использование:

```
spi-flasher [опции] read <имя-файла>
```

Читает данные из флешки и сохраняет их в файл. Если опция `--size` не указан, то будет читать до
конца флешки. Для работы функции программа должна знать зармер флешки. Если флешка неопределилась,
то необходимо явно указать её размер через опцию `--flash-size`.

Если вместо имени файла указано "-", то данные будут выводиться в stdout и их можно будет
использовать в конвеере. Например `spi-flasher read - -s 100 > myfile.dat`.

## Команда flash

Использование:

```
spi-flasher [опции] flash <имя-файла>
```

Читает данные из файла и записывает их во флешку. Будет записан весь файл, но не более размера,
указанного через `--size`. Так же запись остановится, если будет достигнут конец флешки.
Перед записью программа сама очистит участок флешки, необходимый для записи.

Если размеры `--offset` и `--size` (или размер файла) не кратны размеру erase-блока, то будут
очищены затронутые сектора, данные за пределами `--offset` и `--size` будут восстановлены
(подробнее смотри описание команды erase).

Только после этого будут записаны данные из файла (512 байт, начиная со смещения 1024).

Для прошивки программа должна знать размер флешки, erase-блока и страницы. Если флешка не
определилась, то можно явно указать размеры через опции `--flash-size`, `--flash-eraseblock` и
`--flash-page`.

Если вместо имени файла указано "-", то данные будут читаться из stdin.
Например `cat myfile.dat | spi-flasher flash -`. Так как при использовании stdin невозможно
заранее определить размер данных, то очистка блоков будет производиться перед непосредственной
записью в блок.

## Команда erase

Использование:

```
spi-flasher [опции] erase
```

Очищает память флешки. Если `--size` не указан, то будет очищать до конца флешки. Очистка
производится erase-блоками.

Если размеры `--offset` и `--size` не кратны размеру erase-блока, то будут очищены затронутые
сектора, данные за пределами `--offset` и `--size` будут восстановлены.

Например, если размер erase-блока 64 КиБ, а указано `--offset 1K --size 512` (т.е. необходимо
записать данные с адресами 1024...1535 байт), последовательность действий будет такая:

1. Прочитано содержимое erase-блока.
2. Очищен erase-блок.
3. Восстановлены данные до `--offset` (первые 1024 байта).
4. Восстановлены данные начиная со смещения 1536.

Для очистки программа должна знать размер флешки и erase-блока. Если флешка не определилась, то
можно явно указать размер erase-блока через опцию `--flash-size` и `--flash-eraseblock`.

## Команда custom

Использование:

```
spi-flasher [опции] custom <bytes_to_send> <response_length>
```

Отправить устройству произвольные данные и прочитать `<response_length>` байт ответа. При вызове
команды `custom` никаких дополнительных обращений по SPI не производится (для других команд
вначале читаются регистры ID для определния типа флешки), поэтому эта команда может использоваться
не только для SPI Flash, но и для любых других устройств с интерфейсом SPI. При запуске
без аргумента `--custom-duplex` вначале будют переданы данные, а только после этого будет
прочитан ответ:

```
MOSI  <send_byte1> <send_byte2> ... <send_byteN>
MISO                                             <recv_byte1> <recv_byte2> ...
```

Если указан `--custom-duplex`, тогда будут читаться данные одновременно с передаваемыми.
Такой режим бесполезен при работе с флешками, но может пригодиться при работе с другими
устройствами:

```
MOSI  <send_byte1> <send_byte2> ... <send_byteN>
MISO  <recv_byte1> <recv_byte2> ... <recv_byteN>
```

Примеры:

`spi-flasher custom '0x3 0 0 0' 10` - отправить команду 3 (чтение флеш-памяти) начиная с
адреса 0 и прочитать 10 байт.

`spi-flasher custom '0x9f' 4` для W25Q64FV выведет:
```
Data to send:
9f
Received data:
ef 40 17 00
```

`spi-flasher custom '0x9f' 4 --custom-duplex` для W25Q64FV выведет:
```
Data to send:
9f
Received data:
ff ef 40 17
```
